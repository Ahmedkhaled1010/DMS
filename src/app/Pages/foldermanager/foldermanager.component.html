<div class="p-4 md:p-8 bg-background text-foreground min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100" dir="rtl">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold mb-1">إدارة المجلدات</h1>
      <p class="text-lg text-muted-foreground dark:text-gray-400">عرض، إضافة، تعديل، وحذف المجلدات الخاصة بك.</p>
    </div>
    <p-button
      label="إضافة مجلد جديد"
      icon="pi pi-plus"
      styleClass="p-button-primary"
      (click)="openNewFolderDialog()"
      class="w-full md:w-auto"
    ></p-button>
  </div>

  <p-card styleClass="main-content-card shadow-lg rounded-xl dark:bg-gray-800">
    <div *ngIf="loading" class="flex flex-col items-center justify-center py-16">
      <p-progressSpinner></p-progressSpinner>
      <p class="mt-4 text-lg">جاري تحميل المجلدات...</p>
    </div>

    <div *ngIf="error" class="flex flex-col items-center justify-center py-16">
      <p class="text-red-500 text-lg mb-4">{{ error }}</p>
      <p-button
        label="إعادة المحاولة"
        icon="pi pi-refresh"
        styleClass="p-button-secondary"
        (click)="fetchFolders()"
      ></p-button>
    </div>

    <div *ngIf="!loading && !error">
      <div *ngIf="folders.length === 0" class="flex flex-col items-center justify-center py-16">
        <i class="pi pi-folder text-7xl text-muted-foreground dark:text-gray-500 mb-4"></i>
        <p class="text-lg mb-2">لا توجد مجلدات. ابدأ بإنشاء واحدة!</p>
        <p-button
          label="إنشاء مجلد الآن"
          icon="pi pi-plus"
          styleClass="p-button-primary"
          (click)="openNewFolderDialog()"
        ></p-button>
      </div>

      <div *ngIf="folders.length > 0" class="overflow-x-auto rounded-lg shadow mt-4">
        <p-table
          [value]="folders | slice:first:(first + rows)"
          [paginator]="true"
          [rows]="rows"
          [totalRecords]="totalRecords"
          [rowsPerPageOptions]="[5, 10, 20]"
          (onPage)="onPageChange($event)"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="عرض {first} إلى {last} من {totalRecords} مجلد"
          styleClass="p-datatable-gridlines p-datatable-sm dark:bg-gray-800 dark:text-gray-100"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="w-1/4">الاسم</th>
              <th class="w-1/4">الوصف</th>
              <th class="w-1/4">الوالد</th>
              <th class="w-1/6">تاريخ الإنشاء</th>
              <th class="w-1/6">تاريخ التحديث</th>
              <th class="w-1/6">الإجراءات</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-folder>
            <tr>
              <td>
                <a [routerLink]="['/folders', folder.id]" class="text-primary hover:underline font-medium dark:text-blue-400">
                  {{ folder.name }}
                </a>
              </td>
              <td>{{ folder.description || 'لا يوجد وصف' }}</td>
              <td>{{ getParentName(folder.parentId, folder.parentType) }}</td>
              <td>{{ folder.createdAt | date : "short" }}</td>
              <td>{{ folder.updatedAt | date : "short" }}</td>
              <td>
                <div class="flex gap-2">
                  <p-button
                    icon="pi pi-pencil"
                    styleClass="p-button-sm p-button-text p-button-info"
                    (click)="editFolder(folder)"
                    pTooltip="تعديل"
                    tooltipPosition="top"
                  ></p-button>
                  <p-button
                    icon="pi pi-trash"
                    styleClass="p-button-sm p-button-text p-button-danger"
                    (click)="confirmDeleteFolder($event, folder)"
                    pTooltip="حذف"
                    tooltipPosition="top"
                  ></p-button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center">لا توجد مجلدات لعرضها.</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="paginatorleft">
            <p-button type="button" icon="pi pi-refresh" styleClass="p-button-text" (click)="fetchFolders()"></p-button>
          </ng-template>
        </p-table>
      </div>
    </div>
  </p-card>

  <!-- Dialog for Add/Edit Folder -->
  <p-dialog
    [(visible)]="showFolderDialog"
    [header]="isEditMode ? 'تعديل المجلد' : 'إضافة مجلد جديد'"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '500px' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="folder-dialog dark:bg-gray-900"
    (onHide)="folderForm.reset()"
  >
    <form [formGroup]="folderForm" class="p-fluid space-y-4">
      <div>
        <label for="name" class="block text-sm font-medium mb-2">الاسم</label>
        <input id="name" type="text" pInputText formControlName="name"
               [ngClass]="{'ng-invalid ng-dirty': folderForm.get('name')?.invalid && folderForm.get('name')?.touched}" />
        <small *ngIf="folderForm.get('name')?.invalid && folderForm.get('name')?.touched" class="p-error">الاسم مطلوب.</small>
      </div>
      <div>
        <label for="description" class="block text-sm font-medium mb-2">الوصف</label>
        <textarea id="description" pInputTextarea formControlName="description" rows="3"></textarea>
      </div>
      <div>
        <label for="parentId" class="block text-sm font-medium mb-2">الوالد (مساحة عمل أو مجلد)</label>
        <p-dropdown
          id="parentId"
          [options]="parentOptions"
          formControlName="parentId"
          optionLabel="name"
          optionValue="id"
          placeholder="اختر الوالد"
          [filter]="true"
          [ngClass]="{'ng-invalid ng-dirty': folderForm.get('parentId')?.invalid && folderForm.get('parentId')?.touched}"
        ></p-dropdown>
        <small *ngIf="folderForm.get('parentId')?.invalid && folderForm.get('parentId')?.touched" class="p-error">الوالد مطلوب.</small>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-2">
        <p-button label="إلغاء" icon="pi pi-times" (onClick)="showFolderDialog = false" styleClass="p-button-text"></p-button>
        <p-button
          [label]="isEditMode ? 'حفظ التغييرات' : 'إضافة'"
          icon="pi pi-check"
          (onClick)="saveFolder()"
          [disabled]="folderForm.invalid"
        ></p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>